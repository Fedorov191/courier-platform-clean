rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    function isRestaurant() {
      return signedIn() && exists(/databases/$(database)/documents/restaurants/$(request.auth.uid));
    }

    function isCourier() {
      return signedIn() && exists(/databases/$(database)/documents/couriers/$(request.auth.uid));
    }

    function offerStatusOnlyChange() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(["status", "updatedAt"]);
    }

    // ----------------------------
    // CHAT HELPERS
    // ----------------------------
    function isChatParticipant(chatId) {
      return signedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && (
          get(/databases/$(database)/documents/chats/$(chatId)).data.restaurantId == request.auth.uid
          || get(/databases/$(database)/documents/chats/$(chatId)).data.courierId == request.auth.uid
        );
    }

    function canCreateChat() {
      return signedIn()
        && request.resource.data.keys().hasAll(["orderId","restaurantId","courierId"])
        && (
          request.resource.data.restaurantId == request.auth.uid
          || request.resource.data.courierId == request.auth.uid
        );
    }

    function immutableChatFields() {
      return request.resource.data.orderId == resource.data.orderId
        && request.resource.data.restaurantId == resource.data.restaurantId
        && request.resource.data.courierId == resource.data.courierId;
    }

    // ----------------------------
    // Restaurants: только свой документ
    // ----------------------------
    match /restaurants/{restaurantId} {
      allow read, write: if signedIn() && request.auth.uid == restaurantId;
    }

    // ----------------------------
    // Couriers: только свой документ
    // ----------------------------
    match /couriers/{courierId} {
      allow read, write: if signedIn() && request.auth.uid == courierId;
    }

    // ----------------------------
    // Courier public presence/location
    // ----------------------------
    match /courierPublic/{courierId} {
      allow read: if signedIn() && (isRestaurant() || (isCourier() && request.auth.uid == courierId));
      allow write: if signedIn() && isCourier() && request.auth.uid == courierId;
    }

    // ----------------------------
    // Chats (ВАЖНО: на верхнем уровне!)
    // ----------------------------
    match /chats/{chatId} {
      allow read: if isChatParticipant(chatId);
      allow create: if canCreateChat();
      allow update: if isChatParticipant(chatId) && immutableChatFields();
      allow delete: if false;

      match /messages/{msgId} {
        allow read: if isChatParticipant(chatId);

        allow create: if isChatParticipant(chatId)
          && request.resource.data.keys().hasOnly(["text","senderId","senderRole","createdAt"])
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && request.resource.data.text.size() <= 1000
          && request.resource.data.senderId == request.auth.uid
          && (request.resource.data.senderRole == "courier" || request.resource.data.senderRole == "restaurant");

        allow update, delete: if false;
      }
    }

    // ----------------------------
    // Orders
    // ----------------------------
    match /orders/{orderId} {

      // CREATE: только ресторан создаёт заказ для себя
      allow create: if signedIn()
        && isRestaurant()
        && request.resource.data.restaurantId == request.auth.uid
        && (
          !("assignedCourierId" in request.resource.data)
          || request.resource.data.assignedCourierId == null
        );

      // READ
      allow read: if signedIn() && (
        (isRestaurant() && resource.data.restaurantId == request.auth.uid)
        ||
        (isCourier() && (
          resource.data.assignedCourierId == request.auth.uid
          || resource.data.assignedCourierId == null
        ))
      );

      // UPDATE
      allow update: if signedIn() && (
        (isRestaurant() && resource.data.restaurantId == request.auth.uid)
        ||
        (isCourier() && (
          (
            resource.data.assignedCourierId == null
            && (resource.data.status == "new" || resource.data.status == "offered")
            && request.resource.data.assignedCourierId == request.auth.uid
            && request.resource.data.status == "taken"
          )
          ||
          (
            resource.data.assignedCourierId == request.auth.uid
            && (resource.data.status == "taken" || resource.data.status == "picked_up")
          )
        ))
      );

      allow delete: if false;
    }

    // ----------------------------
    // Offers
    // ----------------------------
    match /offers/{offerId} {
      allow create: if signedIn()
        && isRestaurant()
        && request.resource.data.restaurantId == request.auth.uid;

      allow read: if signedIn() && (
        (isCourier() && resource.data.courierId == request.auth.uid)
        ||
        (isRestaurant() && resource.data.restaurantId == request.auth.uid)
      );

      allow update: if signedIn() && (
        (
          isCourier()
          && resource.data.courierId == request.auth.uid
          && offerStatusOnlyChange()
          && request.resource.data.status in ["accepted", "declined"]
        )
        ||
        (
          isRestaurant()
          && resource.data.restaurantId == request.auth.uid
          && offerStatusOnlyChange()
          && request.resource.data.status in ["cancelled", "expired"]
        )
      );

      allow delete: if false;
    }
  }
}
