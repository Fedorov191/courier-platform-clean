rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------
    // HELPERS
    // ----------------------------
    function signedIn() { return request.auth != null; }

    function isRestaurant() {
      return signedIn()
        && exists(/databases/$(database)/documents/restaurants/$(request.auth.uid));
    }

    function isCourier() {
      return signedIn()
        && exists(/databases/$(database)/documents/couriers/$(request.auth.uid));
    }

    function onlyChanges(keys) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(keys);
    }

    function offerStatusOnlyChange() {
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(["status", "updatedAt"]);
    }

    // Курьер читает заказ только если:
    // - заказ назначен ему
    // - ИЛИ заказ предложен ему (currentOfferCourierId)
    function courierCanReadOrder() {
      return isCourier() && (
        resource.data.assignedCourierId == request.auth.uid
        || resource.data.currentOfferCourierId == request.auth.uid
      );
    }

    function courierCanTake() {
      return isCourier()
        && resource.data.assignedCourierId == null
        && (resource.data.status == "new" || resource.data.status == "offered")
        && resource.data.currentOfferCourierId == request.auth.uid
        && request.resource.data.assignedCourierId == request.auth.uid
        && request.resource.data.status == "taken"
        && onlyChanges(["assignedCourierId", "status", "acceptedAt", "updatedAt"]);
    }

    function courierCanPickUp() {
      return isCourier()
        && resource.data.assignedCourierId == request.auth.uid
        && resource.data.status == "taken"
        && request.resource.data.status == "picked_up"
        && onlyChanges(["status", "pickedUpAt", "updatedAt"]);
    }

    function courierCanDeliver() {
      return isCourier()
        && resource.data.assignedCourierId == request.auth.uid
        && resource.data.status == "picked_up"
        && request.resource.data.status == "delivered"
        && onlyChanges([
          "status",
          "deliveredAt",
          "deliveredDateKey",
          "deliveredMonthKey",
          "deliveredYearKey",
          "updatedAt"
        ]);
    }

    // ----------------------------
    // CHAT HELPERS (FIXED)
    // ----------------------------

    // ВАЖНО:
    // - для /chats/{chatId} НЕ используем get() (иначе рекурсия)
    function isChatDocParticipant() {
      return signedIn()
        && (
          resource.data.restaurantId == request.auth.uid
          || resource.data.courierId == request.auth.uid
        );
    }

    // Для messages нужно читать parent chat doc через get()
    function chatDoc(chatId) {
      return get(/databases/$(database)/documents/chats/$(chatId));
    }

    function isChatParticipant(chatId) {
      return signedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && (
          chatDoc(chatId).data.restaurantId == request.auth.uid
          || chatDoc(chatId).data.courierId == request.auth.uid
        );
    }

    function immutableChatFields() {
      return request.resource.data.orderId == resource.data.orderId
        && request.resource.data.restaurantId == resource.data.restaurantId
        && request.resource.data.courierId == resource.data.courierId;
    }

    // Создание чата:
    // - id должен быть {orderId}_{courierId}
    // - order должен существовать
    // - restaurantId должен совпасть с order.restaurantId
    // - courierId должен быть assignedCourierId ИЛИ currentOfferCourierId
    function canCreateChat(chatId) {
      return signedIn()
        && request.resource.data.keys().hasAll(["orderId", "restaurantId", "courierId"])
        && request.resource.data.orderId is string
        && request.resource.data.restaurantId is string
        && request.resource.data.courierId is string
        && chatId == (request.resource.data.orderId + "_" + request.resource.data.courierId)
        && (
          request.auth.uid == request.resource.data.restaurantId
          || request.auth.uid == request.resource.data.courierId
        )
        && exists(/databases/$(database)/documents/orders/$(request.resource.data.orderId))
        && (
          get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.restaurantId
            == request.resource.data.restaurantId
        )
        && (
          get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.assignedCourierId
            == request.resource.data.courierId
          || get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.currentOfferCourierId
            == request.resource.data.courierId
        );
    }

    // ----------------------------
    // Restaurants
    // ----------------------------
    match /restaurants/{restaurantId} {
      allow read, write: if signedIn() && request.auth.uid == restaurantId;
    }

    match /restaurants/{restaurantId}/dayCounters/{dateKey} {
      allow read, write: if signedIn() && request.auth.uid == restaurantId;
    }

    // ----------------------------
    // Couriers
    // ----------------------------
    match /couriers/{courierId} {
      allow read, write: if signedIn() && request.auth.uid == courierId;
    }

    // ----------------------------
    // Courier public presence/location
    // ----------------------------
    match /courierPublic/{courierId} {
      allow read: if signedIn() && (isRestaurant() || (isCourier() && request.auth.uid == courierId));
      allow write: if signedIn() && isCourier() && request.auth.uid == courierId;
    }
match /couriers/{courierId}/fcmTokens/{tokenId} {
  allow read, write: if signedIn() && request.auth.uid == courierId;
}

match /restaurants/{restaurantId}/fcmTokens/{tokenId} {
  allow read, write: if signedIn() && request.auth.uid == restaurantId;
}

    // ----------------------------
    // Chats
    // ----------------------------
    match /chats/{chatId} {
      allow read: if isChatDocParticipant();

      allow create: if canCreateChat(chatId);

      // ✅ UPDATE: только read-receipts + updatedAt
      allow update: if isChatDocParticipant()
        && immutableChatFields()
        && (
          // ресторан может обновлять только свои readAt
          (resource.data.restaurantId == request.auth.uid
            && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(["restaurantLastReadAt", "lastReadAtRestaurant", "updatedAt"])
          )
          ||
          // курьер может обновлять только свои readAt
          (resource.data.courierId == request.auth.uid
            && request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(["courierLastReadAt", "lastReadAtCourier", "updatedAt"])
          )
        );

      allow delete: if false;

      match /messages/{msgId} {
        allow read: if isChatParticipant(chatId);

        // ✅ CREATE message:
        // - нельзя подделать senderRole
        // - createdAt должен быть serverTimestamp (== request.time)
        allow create: if isChatParticipant(chatId)
          && request.resource.data.keys().hasOnly(["text", "senderId", "senderRole", "createdAt"])
          && request.resource.data.text is string
          && request.resource.data.text.size() > 0
          && request.resource.data.text.size() <= 1000
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.createdAt == request.time
          && (
            (request.resource.data.senderRole == "restaurant"
              && request.auth.uid == chatDoc(chatId).data.restaurantId)
            ||
            (request.resource.data.senderRole == "courier"
              && request.auth.uid == chatDoc(chatId).data.courierId)
          );

        allow update, delete: if false;
      }
    }

    // ----------------------------
    // Orders
    // ----------------------------
    match /orders/{orderId} {

      allow create: if signedIn()
        && isRestaurant()
        && request.resource.data.restaurantId == request.auth.uid
        && (
          !("assignedCourierId" in request.resource.data)
          || request.resource.data.assignedCourierId == null
        );

      allow read: if signedIn() && (
        (isRestaurant() && resource.data.restaurantId == request.auth.uid)
        || courierCanReadOrder()
      );

      allow update: if signedIn() && (
        (isRestaurant() && resource.data.restaurantId == request.auth.uid)
        || courierCanTake()
        || courierCanPickUp()
        || courierCanDeliver()
      );

      allow delete: if false;
    }

    // ----------------------------
    // Offers
    // ----------------------------
    match /offers/{offerId} {
      allow create: if false; // только Cloud Functions (Admin SDK)

      allow read: if signedIn() && (
        (isCourier() && resource.data.courierId == request.auth.uid)
        || (isRestaurant() && resource.data.restaurantId == request.auth.uid)
      );

      allow update: if signedIn()
        && isCourier()
        && resource.data.courierId == request.auth.uid
        && resource.data.status == "pending"
        && offerStatusOnlyChange()
        && request.resource.data.status in ["accepted", "declined"];

      allow delete: if false;
    }
  }
}
