rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    function isRestaurant() {
      return signedIn() && exists(/databases/$(database)/documents/restaurants/$(request.auth.uid));
    }

    function isCourier() {
      return signedIn() && exists(/databases/$(database)/documents/couriers/$(request.auth.uid));
    }
function offerStatusOnlyChange() {
  return request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(["status", "updatedAt"]);
}

    // --- Restaurants: только свой документ ---
    match /restaurants/{restaurantId} {
      allow read, write: if signedIn() && request.auth.uid == restaurantId;
    }

    // --- Couriers: только свой документ ---
    match /couriers/{courierId} {
      allow read, write: if signedIn() && request.auth.uid == courierId;
    }

    // --- Courier public presence/location (для подбора) ---
    match /courierPublic/{courierId} {
      allow read: if signedIn() && (isRestaurant() || (isCourier() && request.auth.uid == courierId));
      allow write: if signedIn() && isCourier() && request.auth.uid == courierId;
    }

    // --- Orders ---
    match /orders/{orderId} {

      // CREATE: только ресторан создаёт заказ для себя
      allow create: if signedIn()
        && isRestaurant()
        && request.resource.data.restaurantId == request.auth.uid
        && (
          !("assignedCourierId" in request.resource.data)
          || request.resource.data.assignedCourierId == null
        );

      allow read: if signedIn() && (
        (isRestaurant() && resource.data.restaurantId == request.auth.uid)
        ||
        (isCourier() && (
          resource.data.assignedCourierId == request.auth.uid
          || resource.data.assignedCourierId == null
        ))
      );

      // UPDATE:
      // - ресторан может обновлять свой заказ
      // - курьер может "взять" заказ только если статус new/offered (НЕ cancelled)
      // - и дальше вести заказ только если он назначен ему
      allow update: if signedIn() && (
        (isRestaurant() && resource.data.restaurantId == request.auth.uid)
        ||
        (isCourier() && (
          (
            resource.data.assignedCourierId == null
            && (resource.data.status == "new" || resource.data.status == "offered")
            && request.resource.data.assignedCourierId == request.auth.uid
            && request.resource.data.status == "taken"
          )
          ||
          (
            resource.data.assignedCourierId == request.auth.uid
            && (resource.data.status == "taken" || resource.data.status == "picked_up")
          )
        ))
      );

      allow delete: if false;
    }

match /offers/{offerId} {
  allow create: if signedIn()
    && isRestaurant()
    && request.resource.data.restaurantId == request.auth.uid;

  allow read: if signedIn() && (
    (isCourier() && resource.data.courierId == request.auth.uid)
    ||
    (isRestaurant() && resource.data.restaurantId == request.auth.uid)
  );

  // ✅ update:
  // - courier: только accept/decline (и только status+updatedAt)
  // - restaurant: только cancelled/expired (и только status+updatedAt)
  allow update: if signedIn() && (
    (
      isCourier()
      && resource.data.courierId == request.auth.uid
      && offerStatusOnlyChange()
      && request.resource.data.status in ["accepted", "declined"]
    )
    ||
    (
      isRestaurant()
      && resource.data.restaurantId == request.auth.uid
      && offerStatusOnlyChange()
      && request.resource.data.status in ["cancelled", "expired"]
    )
  );

  allow delete: if false;
}

  }
}
